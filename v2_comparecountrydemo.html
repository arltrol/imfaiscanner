<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Compare Countries powered by AI</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      background: #f9f9f9;
    }
    header {
      background: #72a4fc;
      color: #000;
      padding: 30px 20px;
      text-align: center;
    }
    header h1 {
      font-size: 2.2em;
      margin: 0;
    }
    header p {
      margin-top: 5px;
      font-size: 1.1em;
    }
    main {
      padding: 20px;
    }
    .select-group {
      text-align: center;
      margin-bottom: 20px;
    }
    select, button {
      margin: 0 5px;
      font-size: 1em;
      padding: 6px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
    }
    .chart-card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      padding: 16px;
    }
    canvas {
      width: 100% !important;
      height: 200px !important;
    }
  </style>
</head>
<body>
  <header>
    <h1>Compare Countries powered by AI</h1>
    <p>Explore IMF themes across nations</p>
  </header>
  <main>
    <div class="select-group">
      <label>Select up to 3 countries:</label>
      <select id="country1"></select>
      <select id="country2"></select>
      <select id="country3"></select>
      <button onclick="compare()">Compare</button>
    </div>
    <div class="grid" id="chartGrid"></div>
  </main>
  <script>
    let data = [];
    let countries = new Set();
    let charts = [];

    const THEMES = [
      { id: 'austerity', label: 'Austerity', code: '1' },
      { id: 'tax', label: 'Tax', code: '2' },
      { id: 'climate', label: 'Climate and Environment', code: '3' },
      { id: 'social', label: 'Social and Gendered Impacts', code: '4' },
      { id: 'services', label: 'Social Services', code: '5' },
      { id: 'private', label: 'Private and External Sector', code: '6' },
      { id: 'finance', label: 'Financialisation', code: '7' },
      { id: 'digital', label: 'Digitisation', code: '8' },
      { id: 'governance', label: 'Governance and Political Economy', code: '9' }
    ];

    const COLORS = ['#e74c3c', '#2ecc71', '#3498db'];

    fetch('reports_scrapev2_oldJuly27_1829.json')
      .then(res => res.json())
      .then(json => {
        data = json;
        countries = new Set(data.map(d => d.country).filter(Boolean).sort());
        ['country1','country2','country3'].forEach(id => {
          const sel = document.getElementById(id);
          sel.innerHTML = '<option value="">-- Select --</option>' + [...countries].map(c => `<option>${c}</option>`).join('');
        });
      });

    function countThemesByCountry(country) {
      const counts = Object.fromEntries(THEMES.map(t => [t.code, 0]));
      data.filter(d => d.country === country).forEach(report => {
        const ai = report.ai_analysis?.find(a => a.model === 'gpt-4-turbo');
        if (ai?.content?.all_themes) {
          ai.content.all_themes.forEach(code => {
            const top = code.split('.')[0];
            if (counts[top] !== undefined) counts[top]++;
          });
        }
      });
      return THEMES.map(t => counts[t.code]);
    }

    function compare() {
      const selected = [
        document.getElementById('country1').value,
        document.getElementById('country2').value,
        document.getElementById('country3').value
      ].filter(Boolean);

      if (selected.length < 1) return alert('Select at least one country.');

      // Destroy previous charts
      charts.forEach(c => c.destroy());
      charts = [];

      const grid = document.getElementById('chartGrid');
      grid.innerHTML = '';

      THEMES.forEach(theme => {
        const counts = selected.map(c => countThemesByCountry(c)[THEMES.findIndex(t => t.id === theme.id)]);
        const chartId = 'chart-' + theme.id;

        const card = document.createElement('div');
        card.className = 'chart-card';
        card.innerHTML = `<h4>${theme.label}</h4><canvas id="${chartId}"></canvas>`;
        grid.appendChild(card);

        const ctx = document.getElementById(chartId);
        charts.push(new Chart(ctx, {
  type: 'bar',
  data: {
    labels: selected,
    datasets: [{
      label: theme.label,
      data: counts,
      backgroundColor: COLORS.slice(0, selected.length)
    }]
  },
  options: {
    responsive: true,
    animation: {
      duration: 300,
      onComplete: () => {
        setTimeout(() => {
          Chart.helpers.each(Chart.instances, i => i.resize());
        }, 0);
      }
    },
    plugins: {
      legend: { display: false },
      tooltip: { enabled: true }
    },
    onClick: (event, elements) => {
      if (elements.length > 0) {
        const chart = elements[0].element.$context.chart;
        const index = elements[0].index;
        const datasetIndex = elements[0].datasetIndex;
        const theme = chart.data.datasets[datasetIndex].label;
        const country = chart.data.labels[index];
        const value = chart.data.datasets[datasetIndex].data[index];
        alert(`${theme} in ${country}: ${value} mentions`);
      }
    },
    scales: {
      y: {
        beginAtZero: true,
        ticks: { stepSize: 10 },
        title: { display: true, text: 'Mentions across reports' }
    }
    }
    }
        }));

      });
    }
  </script>
</body>
</html>
